"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.appInfoFromDict = appInfoFromDict;
exports.pageArrayFromDict = pageArrayFromDict;
exports.getDebuggerAppKey = getDebuggerAppKey;
exports.getPossibleDebuggerAppKeys = getPossibleDebuggerAppKeys;
exports.checkParams = checkParams;
exports.wrapScriptForFrame = wrapScriptForFrame;
exports.getScriptForAtom = getScriptForAtom;
exports.simpleStringify = simpleStringify;
exports.deferredPromise = deferredPromise;
exports.getElapsedTime = getElapsedTime;
exports.convertResult = convertResult;
exports.RESPONSE_LOG_LENGTH = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _atoms = _interopRequireDefault(require("./atoms"));

var _lodash = _interopRequireDefault(require("lodash"));

var _assert = _interopRequireDefault(require("assert"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumBaseDriver = require("appium-base-driver");

const WEB_CONTENT_BUNDLE_ID = 'com.apple.WebKit.WebContent';
const WILDCARD_BUNDLE_ID = '*';
const RESPONSE_LOG_LENGTH = 100;
exports.RESPONSE_LOG_LENGTH = RESPONSE_LOG_LENGTH;

function appInfoFromDict(dict) {
  const id = dict.WIRApplicationIdentifierKey;
  const isProxy = _lodash.default.isString(dict.WIRIsApplicationProxyKey) ? dict.WIRIsApplicationProxyKey.toLowerCase() === 'true' : dict.WIRIsApplicationProxyKey;
  let isAutomationEnabled = !!dict.WIRRemoteAutomationEnabledKey;

  if (_lodash.default.has(dict, 'WIRAutomationAvailabilityKey')) {
    if (_lodash.default.isString(dict.WIRAutomationAvailabilityKey)) {
      isAutomationEnabled = dict.WIRAutomationAvailabilityKey === 'WIRAutomationAvailabilityUnknown' ? 'Unknown' : dict.WIRAutomationAvailabilityKey === 'WIRAutomationAvailabilityAvailable';
    } else {
      isAutomationEnabled = !!dict.WIRAutomationAvailabilityKey;
    }
  }

  const entry = {
    id,
    isProxy,
    name: dict.WIRApplicationNameKey,
    bundleId: dict.WIRApplicationBundleIdentifierKey,
    hostId: dict.WIRHostApplicationIdentifierKey,
    isActive: dict.WIRIsApplicationActiveKey,
    isAutomationEnabled
  };
  return [id, entry];
}

function pageArrayFromDict(pageDict) {
  if (pageDict.id) {
    return [pageDict];
  }

  let newPageArray = [];

  for (const dict of _lodash.default.values(pageDict)) {
    if (_lodash.default.isUndefined(dict.WIRTypeKey) || dict.WIRTypeKey === 'WIRTypeWeb') {
      newPageArray.push({
        id: dict.WIRPageIdentifierKey,
        title: dict.WIRTitleKey,
        url: dict.WIRURLKey,
        isKey: !_lodash.default.isUndefined(dict.WIRConnectionIdentifierKey)
      });
    }
  }

  return newPageArray;
}

function getDebuggerAppKey(bundleId, appDict) {
  let appId;

  for (const [key, data] of _lodash.default.toPairs(appDict)) {
    if (data.bundleId === bundleId) {
      appId = key;
      break;
    }
  }

  if (appId) {
    _logger.default.debug(`Found app id key '${appId}' for bundle '${bundleId}'`);

    let proxyAppId;

    for (const [key, data] of _lodash.default.toPairs(appDict)) {
      if (data.isProxy && data.hostId === appId) {
        _logger.default.debug(`Found separate bundleId '${data.bundleId}' ` + `acting as proxy for '${bundleId}', with app id '${key}'`);

        proxyAppId = key;
      }
    }

    if (proxyAppId) {
      appId = proxyAppId;

      _logger.default.debug(`Using proxied app id '${appId}'`);
    }
  }

  return appId;
}

function appIdForBundle(bundleId, appDict) {
  let appId;

  for (const [key, data] of _lodash.default.toPairs(appDict)) {
    if (data.bundleId.endsWith(bundleId)) {
      appId = key;
      break;
    }
  }

  if (!appId && bundleId !== WEB_CONTENT_BUNDLE_ID) {
    return appIdForBundle(WEB_CONTENT_BUNDLE_ID, appDict);
  }

  return appId;
}

function getPossibleDebuggerAppKeys(bundleIds, appDict) {
  let proxiedAppIds = [];

  for (const bundleId of [...bundleIds, WILDCARD_BUNDLE_ID]) {
    const appId = appIdForBundle(bundleId, appDict);

    if (appId) {
      proxiedAppIds.push(appId);

      _logger.default.debug(`Found app id key '${appId}' for bundle '${bundleId}'`);

      for (const [key, data] of _lodash.default.toPairs(appDict)) {
        if (data.isProxy && data.hostId === appId) {
          _logger.default.debug(`Found separate bundleId '${data.bundleId}' ` + `acting as proxy for '${bundleId}', with app id '${key}'`);

          proxiedAppIds.push(key);
        }
      }
    }
  }

  return proxiedAppIds;
}

function checkParams(params) {
  let errors = [];

  for (const [param, value] of _lodash.default.toPairs(params)) {
    try {
      _assert.default.ok(value);
    } catch (err) {
      errors.push(param);
    }
  }

  if (errors.length) {
    return errors;
  }
}

async function wrapScriptForFrame(script, frame) {
  _logger.default.debug(`Wrapping script for frame '${frame}'`);

  let elFromCache = await (0, _atoms.default)('get_element_from_cache');
  return `(function (window) { var document = window.document; ` + `return (${script}); })((${elFromCache.toString('utf8')})(${JSON.stringify(frame)}))`;
}

async function getScriptForAtom(atom, args, frames, asyncCallBack = null) {
  let atomSrc = await (0, _atoms.default)(atom);
  let script;

  if (frames.length > 0) {
    script = atomSrc;

    for (const frame of frames) {
      script = await wrapScriptForFrame(script, frame);
    }
  } else {
    _logger.default.debug(`Executing '${atom}' atom in default context`);

    script = `(${atomSrc})`;
  }

  args = args.map(JSON.stringify);

  if (asyncCallBack) {
    script += `(${args.join(',')}, ${asyncCallBack}, true )`;
  } else {
    script += `(${args.join(',')})`;
  }

  return script;
}

function simpleStringify(value, multiline = false) {
  if (!value) {
    return JSON.stringify(value);
  }

  let cleanValue = _lodash.default.clone(value);

  for (const property of ['ceil', 'clone', 'floor', 'round', 'scale', 'toString']) {
    delete cleanValue[property];
  }

  return multiline ? JSON.stringify(cleanValue, null, 2) : JSON.stringify(cleanValue);
}

function deferredPromise() {
  let resolve;
  let reject;
  const promise = new _bluebird.default((res, rej) => {
    resolve = res;
    reject = rej;
  });
  return {
    promise,
    resolve,
    reject
  };
}

function getElapsedTime(startTime) {
  const endTime = process.hrtime(startTime);
  return parseInt((endTime[0] * 1e9 + endTime[1]) / 1e6, 10);
}

function convertResult(res) {
  if (_lodash.default.isUndefined(res)) {
    throw new Error(`Did not get OK result from remote debugger. Result was: ${_lodash.default.truncate(simpleStringify(res), {
      length: RESPONSE_LOG_LENGTH
    })}`);
  } else if (_lodash.default.isString(res)) {
    try {
      res = JSON.parse(res);
    } catch (err) {}
  } else if (!_lodash.default.isObject(res)) {
    throw new Error(`Result has unexpected type: (${typeof res}).`);
  }

  if (res.status && res.status !== 0) {
    throw (0, _appiumBaseDriver.errorFromMJSONWPStatusCode)(res.status, res.value.message || res.value);
  }

  return _lodash.default.has(res, 'value') ? res.value : res;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9oZWxwZXJzLmpzIl0sIm5hbWVzIjpbIldFQl9DT05URU5UX0JVTkRMRV9JRCIsIldJTERDQVJEX0JVTkRMRV9JRCIsIlJFU1BPTlNFX0xPR19MRU5HVEgiLCJhcHBJbmZvRnJvbURpY3QiLCJkaWN0IiwiaWQiLCJXSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXkiLCJpc1Byb3h5IiwiXyIsImlzU3RyaW5nIiwiV0lSSXNBcHBsaWNhdGlvblByb3h5S2V5IiwidG9Mb3dlckNhc2UiLCJpc0F1dG9tYXRpb25FbmFibGVkIiwiV0lSUmVtb3RlQXV0b21hdGlvbkVuYWJsZWRLZXkiLCJoYXMiLCJXSVJBdXRvbWF0aW9uQXZhaWxhYmlsaXR5S2V5IiwiZW50cnkiLCJuYW1lIiwiV0lSQXBwbGljYXRpb25OYW1lS2V5IiwiYnVuZGxlSWQiLCJXSVJBcHBsaWNhdGlvbkJ1bmRsZUlkZW50aWZpZXJLZXkiLCJob3N0SWQiLCJXSVJIb3N0QXBwbGljYXRpb25JZGVudGlmaWVyS2V5IiwiaXNBY3RpdmUiLCJXSVJJc0FwcGxpY2F0aW9uQWN0aXZlS2V5IiwicGFnZUFycmF5RnJvbURpY3QiLCJwYWdlRGljdCIsIm5ld1BhZ2VBcnJheSIsInZhbHVlcyIsImlzVW5kZWZpbmVkIiwiV0lSVHlwZUtleSIsInB1c2giLCJXSVJQYWdlSWRlbnRpZmllcktleSIsInRpdGxlIiwiV0lSVGl0bGVLZXkiLCJ1cmwiLCJXSVJVUkxLZXkiLCJpc0tleSIsIldJUkNvbm5lY3Rpb25JZGVudGlmaWVyS2V5IiwiZ2V0RGVidWdnZXJBcHBLZXkiLCJhcHBEaWN0IiwiYXBwSWQiLCJrZXkiLCJkYXRhIiwidG9QYWlycyIsImxvZyIsImRlYnVnIiwicHJveHlBcHBJZCIsImFwcElkRm9yQnVuZGxlIiwiZW5kc1dpdGgiLCJnZXRQb3NzaWJsZURlYnVnZ2VyQXBwS2V5cyIsImJ1bmRsZUlkcyIsInByb3hpZWRBcHBJZHMiLCJjaGVja1BhcmFtcyIsInBhcmFtcyIsImVycm9ycyIsInBhcmFtIiwidmFsdWUiLCJhc3NlcnQiLCJvayIsImVyciIsImxlbmd0aCIsIndyYXBTY3JpcHRGb3JGcmFtZSIsInNjcmlwdCIsImZyYW1lIiwiZWxGcm9tQ2FjaGUiLCJ0b1N0cmluZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJnZXRTY3JpcHRGb3JBdG9tIiwiYXRvbSIsImFyZ3MiLCJmcmFtZXMiLCJhc3luY0NhbGxCYWNrIiwiYXRvbVNyYyIsIm1hcCIsImpvaW4iLCJzaW1wbGVTdHJpbmdpZnkiLCJtdWx0aWxpbmUiLCJjbGVhblZhbHVlIiwiY2xvbmUiLCJwcm9wZXJ0eSIsImRlZmVycmVkUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJwcm9taXNlIiwiQiIsInJlcyIsInJlaiIsImdldEVsYXBzZWRUaW1lIiwic3RhcnRUaW1lIiwiZW5kVGltZSIsInByb2Nlc3MiLCJocnRpbWUiLCJwYXJzZUludCIsImNvbnZlcnRSZXN1bHQiLCJFcnJvciIsInRydW5jYXRlIiwicGFyc2UiLCJpc09iamVjdCIsInN0YXR1cyIsIm1lc3NhZ2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxxQkFBcUIsR0FBRyw2QkFBOUI7QUFDQSxNQUFNQyxrQkFBa0IsR0FBRyxHQUEzQjtBQUVBLE1BQU1DLG1CQUFtQixHQUFHLEdBQTVCOzs7QUFNQSxTQUFTQyxlQUFULENBQTBCQyxJQUExQixFQUFnQztBQUM5QixRQUFNQyxFQUFFLEdBQUdELElBQUksQ0FBQ0UsMkJBQWhCO0FBQ0EsUUFBTUMsT0FBTyxHQUFHQyxnQkFBRUMsUUFBRixDQUFXTCxJQUFJLENBQUNNLHdCQUFoQixJQUNaTixJQUFJLENBQUNNLHdCQUFMLENBQThCQyxXQUE5QixPQUFnRCxNQURwQyxHQUVaUCxJQUFJLENBQUNNLHdCQUZUO0FBTUEsTUFBSUUsbUJBQW1CLEdBQUcsQ0FBQyxDQUFDUixJQUFJLENBQUNTLDZCQUFqQzs7QUFDQSxNQUFJ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QU0sRUFBRTNEO0FBQVQsS0FBakMsQ0FBZ0UsRUFBckksQ0FBTjtBQUNELEdBRkQsTUFFTyxJQUFJTSxnQkFBRUMsUUFBRixDQUFXOEUsR0FBWCxDQUFKLEVBQXFCO0FBQzFCLFFBQUk7QUFDRkEsTUFBQUEsR0FBRyxHQUFHcEIsSUFBSSxDQUFDK0IsS0FBTCxDQUFXWCxHQUFYLENBQU47QUFDRCxLQUZELENBRUUsT0FBTzNCLEdBQVAsRUFBWSxDQUdiO0FBQ0YsR0FQTSxNQU9BLElBQUksQ0FBQ3BELGdCQUFFMkYsUUFBRixDQUFXWixHQUFYLENBQUwsRUFBc0I7QUFDM0IsVUFBTSxJQUFJUyxLQUFKLENBQVcsZ0NBQStCLE9BQU9ULEdBQUksSUFBckQsQ0FBTjtBQUNEOztBQUVELE1BQUlBLEdBQUcsQ0FBQ2EsTUFBSixJQUFjYixHQUFHLENBQUNhLE1BQUosS0FBZSxDQUFqQyxFQUFvQztBQUVsQyxVQUFNLGtEQUEyQmIsR0FBRyxDQUFDYSxNQUEvQixFQUF1Q2IsR0FBRyxDQUFDOUIsS0FBSixDQUFVNEMsT0FBVixJQUFxQmQsR0FBRyxDQUFDOUIsS0FBaEUsQ0FBTjtBQUNEOztBQUlELFNBQU9qRCxnQkFBRU0sR0FBRixDQUFNeUUsR0FBTixFQUFXLE9BQVgsSUFBc0JBLEdBQUcsQ0FBQzlCLEtBQTFCLEdBQWtDOEIsR0FBekM7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IGdldEF0b20gZnJvbSAnLi9hdG9tcyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGFzc2VydCBmcm9tICdhc3NlcnQnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgZXJyb3JGcm9tTUpTT05XUFN0YXR1c0NvZGUgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuXG5cbmNvbnN0IFdFQl9DT05URU5UX0JVTkRMRV9JRCA9ICdjb20uYXBwbGUuV2ViS2l0LldlYkNvbnRlbnQnO1xuY29uc3QgV0lMRENBUkRfQlVORExFX0lEID0gJyonO1xuXG5jb25zdCBSRVNQT05TRV9MT0dfTEVOR1RIID0gMTAwO1xuXG4vKlxuICogVGFrZXMgYSBkaWN0aW9uYXJ5IGZyb20gdGhlIHJlbW90ZSBkZWJ1Z2dlciBhbmQgbWFrZXMgYSBtb3JlIG1hbmFnZWFibGVcbiAqIGRpY3Rpb25hcnkgd2hvc2Uga2V5cyBhcmUgdW5kZXJzdGFuZGFibGVcbiAqL1xuZnVuY3Rpb24gYXBwSW5mb0Zyb21EaWN0IChkaWN0KSB7XG4gIGNvbnN0IGlkID0gZGljdC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk7XG4gIGNvbnN0IGlzUHJveHkgPSBfLmlzU3RyaW5nKGRpY3QuV0lSSXNBcHBsaWNhdGlvblByb3h5S2V5KVxuICAgID8gZGljdC5XSVJJc0FwcGxpY2F0aW9uUHJveHlLZXkudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnXG4gICAgOiBkaWN0LldJUklzQXBwbGljYXRpb25Qcm94eUtleTtcbiAgLy8gYXV0b21hdGlvbiBlbmFibGVkIGNhbiBiZSBlaXRoZXIgZnJvbSB0aGUga2V5c1xuICAvLyAgIC0gV0lSUmVtb3RlQXV0b21hdGlvbkVuYWJsZWRLZXkgKGJvb2xlYW4pXG4gIC8vICAgLSBXSVJBdXRvbWF0aW9uQXZhaWxhYmlsaXR5S2V5IChzdHJpbmcgb3IgYm9vbGVhbilcbiAgbGV0IGlzQXV0b21hdGlvbkVuYWJsZWQgPSAhIWRpY3QuV0lSUmVtb3RlQXV0b21hdGlvbkVuYWJsZWRLZXk7XG4gIGlmIChfLmhhcyhkaWN0LCAnV0lSQXV0b21hdGlvbkF2YWlsYWJpbGl0eUtleScpKSB7XG4gICAgaWYgKF8uaXNTdHJpbmcoZGljdC5XSVJBdXRvbWF0aW9uQXZhaWxhYmlsaXR5S2V5KSkge1xuICAgICAgaXNBdXRvbWF0aW9uRW5hYmxlZCA9IGRpY3QuV0lSQXV0b21hdGlvbkF2YWlsYWJpbGl0eUtleSA9PT0gJ1dJUkF1dG9tYXRpb25BdmFpbGFiaWxpdHlVbmtub3duJ1xuICAgICAgICA/ICdVbmtub3duJ1xuICAgICAgICA6IGRpY3QuV0lSQXV0b21hdGlvbkF2YWlsYWJpbGl0eUtleSA9PT0gJ1dJUkF1dG9tYXRpb25BdmFpbGFiaWxpdHlBdmFpbGFibGUnO1xuICAgIH0gZWxzZSB7XG4gICAgICBpc0F1dG9tYXRpb25FbmFibGVkID0gISFkaWN0LldJUkF1dG9tYXRpb25BdmFpbGFiaWxpdHlLZXk7XG4gICAgfVxuICB9XG4gIGNvbnN0IGVudHJ5ID0ge1xuICAgIGlkLFxuICAgIGlzUHJveHksXG4gICAgbmFtZTogZGljdC5XSVJBcHBsaWNhdGlvbk5hbWVLZXksXG4gICAgYnVuZGxlSWQ6IGRpY3QuV0lSQXBwbGljYXRpb25CdW5kbGVJZGVudGlmaWVyS2V5LFxuICAgIGhvc3RJZDogZGljdC5XSVJIb3N0QXBwbGljYXRpb25JZGVudGlmaWVyS2V5LFxuICAgIGlzQWN0aXZlOiBkaWN0LldJUklzQXBwbGljYXRpb25BY3RpdmVLZXksXG4gICAgaXNBdXRvbWF0aW9uRW5hYmxlZCxcbiAgfTtcblxuICByZXR1cm4gW2lkLCBlbnRyeV07XG59XG5cbi8qXG4gKiBUYWtlIGEgZGljdGlvbmFyeSBmcm9tIHRoZSByZW1vdGUgZGVidWdnZXIgYW5kIG1ha2VzIGEgbW9yZSBtYW5hZ2VhYmxlXG4gKiBkaWN0aW9uYXJ5IG9mIHBhZ2VzIGF2YWlsYWJsZS5cbiAqL1xuZnVuY3Rpb24gcGFnZUFycmF5RnJvbURpY3QgKHBhZ2VEaWN0KSB7XG4gIGlmIChwYWdlRGljdC5pZCkge1xuICAgIC8vIHRoZSBwYWdlIGlzIGFscmVhZHkgdHJhbnNsYXRlZCwgc28gd3JhcCBpbiBhbiBhcnJheSBhbmQgcGFzcyBiYWNrXG4gICAgcmV0dXJuIFtwYWdlRGljdF07XG4gIH1cbiAgbGV0IG5ld1BhZ2VBcnJheSA9IFtdO1xuICBmb3IgKGNvbnN0IGRpY3Qgb2YgXy52YWx1ZXMocGFnZURpY3QpKSB7XG4gICAgLy8gY291bnQgb25seSBXSVJUeXBlV2ViIHBhZ2VzIGFuZCBpZ25vcmUgYWxsIG90aGVycyAoV0lSVHlwZUphdmFTY3JpcHQgZXRjKVxuICAgIGlmIChfLmlzVW5kZWZpbmVkKGRpY3QuV0lSVHlwZUtleSkgfHwgZGljdC5XSVJUeXBlS2V5ID09PSAnV0lSVHlwZVdlYicpIHtcbiAgICAgIG5ld1BhZ2VBcnJheS5wdXNoKHtcbiAgICAgICAgaWQ6IGRpY3QuV0lSUGFnZUlkZW50aWZpZXJLZXksXG4gICAgICAgIHRpdGxlOiBkaWN0LldJUlRpdGxlS2V5LFxuICAgICAgICB1cmw6IGRpY3QuV0lSVVJMS2V5LFxuICAgICAgICBpc0tleTogIV8uaXNVbmRlZmluZWQoZGljdC5XSVJDb25uZWN0aW9uSWRlbnRpZmllcktleSksXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG5ld1BhZ2VBcnJheTtcbn1cblxuLypcbiAqIEdpdmVuIGEgYnVuZGxlIGlkLCBmaW5kcyB0aGUgY29ycmVjdCByZW1vdGUgZGVidWdnZXIgYXBwIHRoYXQgaXNcbiAqIGNvbm5lY3RlZC5cbiAqL1xuZnVuY3Rpb24gZ2V0RGVidWdnZXJBcHBLZXkgKGJ1bmRsZUlkLCBhcHBEaWN0KSB7XG4gIGxldCBhcHBJZDtcbiAgZm9yIChjb25zdCBba2V5LCBkYXRhXSBvZiBfLnRvUGFpcnMoYXBwRGljdCkpIHtcbiAgICBpZiAoZGF0YS5idW5kbGVJZCA9PT0gYnVuZGxlSWQpIHtcbiAgICAgIGFwcElkID0ga2V5O1xuICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG4gIC8vIG5vdyB3ZSBuZWVkIHRvIGRldGVybWluZSBpZiB3ZSBzaG91bGQgcGljayBhIHByb3h5IGZvciB0aGlzIGluc3RlYWRcbiAgaWYgKGFwcElkKSB7XG4gICAgbG9nLmRlYnVnKGBGb3VuZCBhcHAgaWQga2V5ICcke2FwcElkfScgZm9yIGJ1bmRsZSAnJHtidW5kbGVJZH0nYCk7XG4gICAgbGV0IHByb3h5QXBwSWQ7XG4gICAgZm9yIChjb25zdCBba2V5LCBkYXRhXSBvZiBfLnRvUGFpcnMoYXBwRGljdCkpIHtcbiAgICAgIGlmIChkYXRhLmlzUHJveHkgJiYgZGF0YS5ob3N0SWQgPT09IGFwcElkKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgRm91bmQgc2VwYXJhdGUgYnVuZGxlSWQgJyR7ZGF0YS5idW5kbGVJZH0nIGAgK1xuICAgICAgICAgICAgICAgICAgYGFjdGluZyBhcyBwcm94eSBmb3IgJyR7YnVuZGxlSWR9Jywgd2l0aCBhcHAgaWQgJyR7a2V5fSdgKTtcbiAgICAgICAgLy8gc2V0IHRoZSBhcHAgaWQuLi4gdGhlIGxhc3Qgb25lIHdpbGwgYmUgdXNlZCwgc28ganVzdCBrZWVwIHJlLWFzc2lnbmluZ1xuICAgICAgICBwcm94eUFwcElkID0ga2V5O1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAocHJveHlBcHBJZCkge1xuICAgICAgYXBwSWQgPSBwcm94eUFwcElkO1xuICAgICAgbG9nLmRlYnVnKGBVc2luZyBwcm94aWVkIGFwcCBpZCAnJHthcHBJZH0nYCk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGFwcElkO1xufVxuXG5mdW5jdGlvbiBhcHBJZEZvckJ1bmRsZSAoYnVuZGxlSWQsIGFwcERpY3QpIHtcbiAgbGV0IGFwcElkO1xuICBmb3IgKGNvbnN0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgIGlmIChkYXRhLmJ1bmRsZUlkLmVuZHNXaXRoKGJ1bmRsZUlkKSkge1xuICAgICAgYXBwSWQgPSBrZXk7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICAvLyBpZiBub3RoaW5nIGlzIGZvdW5kLCB0cnkgdG8gZ2V0IHRoZSBnZW5lcmljIGFwcFxuICBpZiAoIWFwcElkICYmIGJ1bmRsZUlkICE9PSBXRUJfQ09OVEVOVF9CVU5ETEVfSUQpIHtcbiAgICByZXR1cm4gYXBwSWRGb3JCdW5kbGUoV0VCX0NPTlRFTlRfQlVORExFX0lELCBhcHBEaWN0KTtcbiAgfVxuXG4gIHJldHVybiBhcHBJZDtcbn1cblxuZnVuY3Rpb24gZ2V0UG9zc2libGVEZWJ1Z2dlckFwcEtleXMgKGJ1bmRsZUlkcywgYXBwRGljdCkge1xuICBsZXQgcHJveGllZEFwcElkcyA9IFtdO1xuXG4gIC8vIGdvIHRocm91Z2ggdGhlIHBvc3NpYmxlIGJ1bmRsZSBpZGVudGlmaWVycywgYWxvbmcgd2l0aCB0aGUgd2lsZGNhcmRcbiAgZm9yIChjb25zdCBidW5kbGVJZCBvZiBbLi4uYnVuZGxlSWRzLCBXSUxEQ0FSRF9CVU5ETEVfSURdKSB7XG4gICAgY29uc3QgYXBwSWQgPSBhcHBJZEZvckJ1bmRsZShidW5kbGVJZCwgYXBwRGljdCk7XG5cbiAgICAvLyBub3cgd2UgbmVlZCB0byBkZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIHBpY2sgYSBwcm94eSBmb3IgdGhpcyBpbnN0ZWFkXG4gICAgaWYgKGFwcElkKSB7XG4gICAgICBwcm94aWVkQXBwSWRzLnB1c2goYXBwSWQpO1xuICAgICAgbG9nLmRlYnVnKGBGb3VuZCBhcHAgaWQga2V5ICcke2FwcElkfScgZm9yIGJ1bmRsZSAnJHtidW5kbGVJZH0nYCk7XG4gICAgICBmb3IgKGNvbnN0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgICAgICBpZiAoZGF0YS5pc1Byb3h5ICYmIGRhdGEuaG9zdElkID09PSBhcHBJZCkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgRm91bmQgc2VwYXJhdGUgYnVuZGxlSWQgJyR7ZGF0YS5idW5kbGVJZH0nIGAgK1xuICAgICAgICAgICAgICAgICAgICBgYWN0aW5nIGFzIHByb3h5IGZvciAnJHtidW5kbGVJZH0nLCB3aXRoIGFwcCBpZCAnJHtrZXl9J2ApO1xuICAgICAgICAgIHByb3hpZWRBcHBJZHMucHVzaChrZXkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHByb3hpZWRBcHBJZHM7XG59XG5cbmZ1bmN0aW9uIGNoZWNrUGFyYW1zIChwYXJhbXMpIHtcbiAgbGV0IGVycm9ycyA9IFtdO1xuICBmb3IgKGNvbnN0IFtwYXJhbSwgdmFsdWVdIG9mIF8udG9QYWlycyhwYXJhbXMpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGFzc2VydC5vayh2YWx1ZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBlcnJvcnMucHVzaChwYXJhbSk7XG4gICAgfVxuICB9XG4gIGlmIChlcnJvcnMubGVuZ3RoKSB7XG4gICAgcmV0dXJuIGVycm9ycztcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB3cmFwU2NyaXB0Rm9yRnJhbWUgKHNjcmlwdCwgZnJhbWUpIHtcbiAgbG9nLmRlYnVnKGBXcmFwcGluZyBzY3JpcHQgZm9yIGZyYW1lICcke2ZyYW1lfSdgKTtcbiAgbGV0IGVsRnJvbUNhY2hlID0gYXdhaXQgZ2V0QXRvbSgnZ2V0X2VsZW1lbnRfZnJvbV9jYWNoZScpO1xuICByZXR1cm4gYChmdW5jdGlvbiAod2luZG93KSB7IHZhciBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudDsgYCArXG4gICAgICAgICBgcmV0dXJuICgke3NjcmlwdH0pOyB9KSgoJHtlbEZyb21DYWNoZS50b1N0cmluZygndXRmOCcpfSkoJHtKU09OLnN0cmluZ2lmeShmcmFtZSl9KSlgO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRTY3JpcHRGb3JBdG9tIChhdG9tLCBhcmdzLCBmcmFtZXMsIGFzeW5jQ2FsbEJhY2sgPSBudWxsKSB7XG4gIGxldCBhdG9tU3JjID0gYXdhaXQgZ2V0QXRvbShhdG9tKTtcbiAgbGV0IHNjcmlwdDtcbiAgaWYgKGZyYW1lcy5sZW5ndGggPiAwKSB7XG4gICAgc2NyaXB0ID0gYXRvbVNyYztcbiAgICBmb3IgKGNvbnN0IGZyYW1lIG9mIGZyYW1lcykge1xuICAgICAgc2NyaXB0ID0gYXdhaXQgd3JhcFNjcmlwdEZvckZyYW1lKHNjcmlwdCwgZnJhbWUpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBsb2cuZGVidWcoYEV4ZWN1dGluZyAnJHthdG9tfScgYXRvbSBpbiBkZWZhdWx0IGNvbnRleHRgKTtcbiAgICBzY3JpcHQgPSBgKCR7YXRvbVNyY30pYDtcbiAgfVxuXG4gIC8vIGFkZCB0aGUgYXJndW1lbnRzLCBhcyBzdHJpbmdzXG4gIGFyZ3MgPSBhcmdzLm1hcChKU09OLnN0cmluZ2lmeSk7XG4gIGlmIChhc3luY0NhbGxCYWNrKSB7XG4gICAgc2NyaXB0ICs9IGAoJHthcmdzLmpvaW4oJywnKX0sICR7YXN5bmNDYWxsQmFja30sIHRydWUgKWA7XG4gIH0gZWxzZSB7XG4gICAgc2NyaXB0ICs9IGAoJHthcmdzLmpvaW4oJywnKX0pYDtcbiAgfVxuXG4gIHJldHVybiBzY3JpcHQ7XG59XG5cbmZ1bmN0aW9uIHNpbXBsZVN0cmluZ2lmeSAodmFsdWUsIG11bHRpbGluZSA9IGZhbHNlKSB7XG4gIGlmICghdmFsdWUpIHtcbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodmFsdWUpO1xuICB9XG5cbiAgLy8gd2UgZ2V0IGJhY2sgb2JqZWN0cyBzb21ldGltZXMgd2l0aCBzdHJpbmcgdmVyc2lvbnMgb2YgZnVuY3Rpb25zXG4gIC8vIHdoaWNoIG11ZGR5IHRoZSBsb2dzXG4gIGxldCBjbGVhblZhbHVlID0gXy5jbG9uZSh2YWx1ZSk7XG4gIGZvciAoY29uc3QgcHJvcGVydHkgb2YgWydjZWlsJywgJ2Nsb25lJywgJ2Zsb29yJywgJ3JvdW5kJywgJ3NjYWxlJywgJ3RvU3RyaW5nJ10pIHtcbiAgICBkZWxldGUgY2xlYW5WYWx1ZVtwcm9wZXJ0eV07XG4gIH1cbiAgcmV0dXJuIG11bHRpbGluZSA/IEpTT04uc3RyaW5naWZ5KGNsZWFuVmFsdWUsIG51bGwsIDIpIDogSlNPTi5zdHJpbmdpZnkoY2xlYW5WYWx1ZSk7XG59XG5cbmZ1bmN0aW9uIGRlZmVycmVkUHJvbWlzZSAoKSB7XG4gIC8vIGh0dHA6Ly9ibHVlYmlyZGpzLmNvbS9kb2NzL2FwaS9kZWZlcnJlZC1taWdyYXRpb24uaHRtbFxuICBsZXQgcmVzb2x2ZTtcbiAgbGV0IHJlamVjdDtcbiAgY29uc3QgcHJvbWlzZSA9IG5ldyBCKChyZXMsIHJlaikgPT4geyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHByb21pc2UvcGFyYW0tbmFtZXNcbiAgICByZXNvbHZlID0gcmVzO1xuICAgIHJlamVjdCA9IHJlajtcbiAgfSk7XG4gIHJldHVybiB7XG4gICAgcHJvbWlzZSxcbiAgICByZXNvbHZlLFxuICAgIHJlamVjdFxuICB9O1xufVxuXG5mdW5jdGlvbiBnZXRFbGFwc2VkVGltZSAoc3RhcnRUaW1lKSB7XG4gIGNvbnN0IGVuZFRpbWUgPSBwcm9jZXNzLmhydGltZShzdGFydFRpbWUpO1xuICByZXR1cm4gcGFyc2VJbnQoKGVuZFRpbWVbMF0gKiAxZTkgKyBlbmRUaW1lWzFdKSAvIDFlNiwgMTApO1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0UmVzdWx0IChyZXMpIHtcbiAgaWYgKF8uaXNVbmRlZmluZWQocmVzKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgRGlkIG5vdCBnZXQgT0sgcmVzdWx0IGZyb20gcmVtb3RlIGRlYnVnZ2VyLiBSZXN1bHQgd2FzOiAke18udHJ1bmNhdGUoc2ltcGxlU3RyaW5naWZ5KHJlcyksIHtsZW5ndGg6IFJFU1BPTlNFX0xPR19MRU5HVEh9KX1gKTtcbiAgfSBlbHNlIGlmIChfLmlzU3RyaW5nKHJlcykpIHtcbiAgICB0cnkge1xuICAgICAgcmVzID0gSlNPTi5wYXJzZShyZXMpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gd2UgbWlnaHQgZ2V0IGEgc2VyaWFsaXplZCBvYmplY3QsIGJ1dCB3ZSBtaWdodCBub3RcbiAgICAgIC8vIGlmIHdlIGdldCBoZXJlLCBpdCBpcyBqdXN0IGEgdmFsdWVcbiAgICB9XG4gIH0gZWxzZSBpZiAoIV8uaXNPYmplY3QocmVzKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgUmVzdWx0IGhhcyB1bmV4cGVjdGVkIHR5cGU6ICgke3R5cGVvZiByZXN9KS5gKTtcbiAgfVxuXG4gIGlmIChyZXMuc3RhdHVzICYmIHJlcy5zdGF0dXMgIT09IDApIHtcbiAgICAvLyB3ZSBnb3Qgc29tZSBmb3JtIG9mIGVycm9yLlxuICAgIHRocm93IGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlKHJlcy5zdGF0dXMsIHJlcy52YWx1ZS5tZXNzYWdlIHx8IHJlcy52YWx1ZSk7XG4gIH1cblxuICAvLyB3aXRoIGVpdGhlciBoYXZlIGFuIG9iamVjdCB3aXRoIGEgYHZhbHVlYCBwcm9wZXJ0eSAoZXZlbiBpZiBgbnVsbGApLFxuICAvLyBvciBhIHBsYWluIG9iamVjdFxuICByZXR1cm4gXy5oYXMocmVzLCAndmFsdWUnKSA/IHJlcy52YWx1ZSA6IHJlcztcbn1cblxuZXhwb3J0IHtcbiAgYXBwSW5mb0Zyb21EaWN0LCBwYWdlQXJyYXlGcm9tRGljdCwgZ2V0RGVidWdnZXJBcHBLZXksXG4gIGdldFBvc3NpYmxlRGVidWdnZXJBcHBLZXlzLCBjaGVja1BhcmFtcywgd3JhcFNjcmlwdEZvckZyYW1lLCBnZXRTY3JpcHRGb3JBdG9tLFxuICBzaW1wbGVTdHJpbmdpZnksIGRlZmVycmVkUHJvbWlzZSwgZ2V0RWxhcHNlZFRpbWUsXG4gIGNvbnZlcnRSZXN1bHQsIFJFU1BPTlNFX0xPR19MRU5HVEgsXG59O1xuIl0sImZpbGUiOiJsaWIvaGVscGVycy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
